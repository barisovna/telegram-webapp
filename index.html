<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ß–∞—Ç —Å –≥–æ–ª–æ—Å–æ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow: hidden;
        }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        #header {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        }
        
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: var(--tg-theme-button-color, #3390ec);
            color: white;
            align-self: flex-end;
        }
        
        .message.bot {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            color: var(--tg-theme-text-color, #000000);
            align-self: flex-start;
        }
        
        .message.system {
            background: #fff3cd;
            color: #856404;
            align-self: center;
            font-size: 14px;
            text-align: center;
            max-width: 90%;
        }
        
        #input-area {
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            font-size: 16px;
            outline: none;
        }
        
        .btn {
            background: var(--tg-theme-button-color, #3390ec);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn:disabled {
            opacity: 0.5;
        }
        
        #voice-btn {
            background: #10b981;
        }
        
        #voice-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .typing {
            display: none;
            padding: 10px 15px;
            background: #f4f4f5;
            border-radius: 15px;
            max-width: 80px;
        }
        
        .typing.active {
            display: block;
        }
        
        .typing span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin-right: 4px;
            animation: bounce 1.4s infinite;
        }
        
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        #quick-buttons {
            padding: 10px 15px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }

        .quick-btn {
            background: #f4f4f5;
            border: 1px solid #e0e0e0;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
        }
        
        #recording-indicator {
            display: none;
            padding: 8px 15px;
            background: #fecaca;
            border-radius: 20px;
            color: #991b1b;
            font-size: 14px;
            text-align: center;
            margin: 0 15px;
        }
        
        #recording-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="header">üé§ AI –ü–æ–º–æ—â–Ω–∏–∫ —Å –≥–æ–ª–æ—Å–æ–º</div>
        
        <div id="quick-buttons">
            <button class="quick-btn" onclick="quickMessage('–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç')">üòÑ –ê–Ω–µ–∫–¥–æ—Ç</button>
            <button class="quick-btn" onclick="quickMessage('–î–∞–π —Å–æ–≤–µ—Ç')">üí° –°–æ–≤–µ—Ç</button>
            <button class="quick-btn" onclick="quickMessage('–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ—é')">üíº –ò–¥–µ—è</button>
        </div>
        
        <div id="recording-indicator">
            üî¥ –°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ!
        </div>
        
        <div id="messages">
            <div class="message system">
                üé§ –ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –≥–æ–≤–æ—Ä–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º!<br>
                –ò–ª–∏ –ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º üëá
            </div>
        </div>
        
        <div class="typing" id="typing">
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <div id="input-area">
            <button id="voice-btn" class="btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
                üé§
            </button>
            <input 
                type="text" 
                id="message-input" 
                placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º..."
                autocomplete="off"
            />
            <button id="send-btn" class="btn">
                ‚û§
            </button>
        </div>
    </div>

    <script>
        // ========================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ========================================
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        const PROXY_URL = window.location.origin + '/api/chat';
        
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const typingIndicator = document.getElementById('typing');
        const recordingIndicator = document.getElementById('recording-indicator');
        
        let conversationHistory = [];
        let isRecording = false;
        let recognition = null;
        
        // ========================================
        // –ì–û–õ–û–°–û–í–û–ô –í–í–û–î (Web Speech API - –ë–ï–°–ü–õ–ê–¢–ù–û)
        // ========================================
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            recognition.lang = 'ru-RU';  // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
            recognition.continuous = false;  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Å–ª–µ —Ñ—Ä–∞–∑—ã
            recognition.interimResults = false;  // –¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            recognition.maxAlternatives = 1;
            
            // –ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å
            recognition.onstart = function() {
                isRecording = true;
                voiceBtn.classList.add('recording');
                recordingIndicator.classList.add('active');
                console.log('üé§ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            };
            
            // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                
                console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', transcript);
                console.log('üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:', (confidence * 100).toFixed(1) + '%');
                
                messageInput.value = transcript;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                setTimeout(() => {
                    sendMessage();
                }, 300);
            };
            
            // –ö–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
            recognition.onend = function() {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                recordingIndicator.classList.remove('active');
                console.log('üî¥ –ó–∞–ø–∏—Å—å –∑–∞–∫–æ–Ω—á–µ–Ω–∞');
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            recognition.onerror = function(event) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
                isRecording = false;
                voiceBtn.classList.remove('recording');
                recordingIndicator.classList.remove('active');
                
                let errorMsg = '';
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = 'üîá –ù–∏—á–µ–≥–æ –Ω–µ —É—Å–ª—ã—à–∞–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                        break;
                    case 'audio-capture':
                        errorMsg = '‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                        break;
                    case 'not-allowed':
                        errorMsg = '‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö';
                        break;
                    case 'network':
                        errorMsg = '‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º';
                        break;
                    default:
                        errorMsg = '‚ùå –û—à–∏–±–∫–∞: ' + event.error;
                }
                
                addMessage(errorMsg, 'system');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            };
            
        } else {
            console.warn('‚ö†Ô∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            voiceBtn.style.display = 'none';
            addMessage('‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'system');
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        voiceBtn.addEventListener('click', function() {
            if (!recognition) {
                addMessage('‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'system');
                return;
            }
            
            if (isRecording) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                recognition.stop();
            } else {
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å
                try {
                    recognition.start();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', e);
                    addMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'system');
                }
            }
        });
        
        // ========================================
        // –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø
        // ========================================
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            messageInput.value = '';
            
            sendBtn.disabled = true;
            voiceBtn.disabled = true;
            messageInput.disabled = true;
            typingIndicator.classList.add('active');
            
            try {
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
                
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: conversationHistory
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
                }
                
                const botReply = data.choices[0].message.content;
                
                conversationHistory.push({
                    role: 'assistant',
                    content: botReply
                });
                
                addMessage(botReply, 'bot');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'system');
                conversationHistory.pop();
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            } finally {
                sendBtn.disabled = false;
                voiceBtn.disabled = false;
                messageInput.disabled = false;
                typingIndicator.classList.remove('active');
                messageInput.focus();
            }
        }
        
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function quickMessage(text) {
            messageInput.value = text;
            sendMessage();
        }
        
        // ========================================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
        // ========================================
        
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        setTimeout(() => messageInput.focus(), 300);
        
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –≤–≤–æ–¥–æ–º –∑–∞–ø—É—â–µ–Ω–æ');
        console.log('üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥:', recognition ? '–†–∞–±–æ—Ç–∞–µ—Ç' : '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        console.log('üîó API URL:', PROXY_URL);
    </script>
</body>
</html>
